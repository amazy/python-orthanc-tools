import pathlib
import subprocess
import unittest, os, glob
import hl7  # https://python-hl7.readthedocs.org/en/latest/
import pydicom
from orthanc_tools import MLLPClient, Hl7MessageValidator, MLLPServer, Hl7ReportParser, ReportSeriesBuilder, Hl7OruReportMsgHandler
import tempfile
import logging
from orthanc_api_client import OrthancApiClient

here = pathlib.Path(__file__).parent.resolve().parent.resolve().parent.resolve().parent.resolve()


class TestHl7OruReportMsgHandler(unittest.TestCase):

    @classmethod
    def setUpClass(cls):
        subprocess.run(["docker", "compose", "down", "-v"], cwd=here/"tests/docker-setup")
        subprocess.run(["docker", "compose", "up", "-d"], cwd=here/"tests/docker-setup")

        cls.oa = OrthancApiClient('http://localhost:10042', user='test', pwd='test')
        cls.oa.wait_started()

    @classmethod
    def tearDownClass(cls):
        subprocess.run(["docker", "compose", "down", "-v"], cwd=here/"tests/docker-setup")

    def test_ried_reports(self):

        # upload the study we will attach the pdf to
        original_instance_id = self.oa.upload_file(here / "tests/stimuli/CT_small.dcm")[0]
        original_study_id = self.oa.instances.get_parent_study_id(original_instance_id)

        port_number = 2001  # there are currently some issues when trying to reuse the same port in 2 tests (it's probably not freed soon enough -> let's use another port for each test)

        parser = Hl7ReportParser()
        orthanc_client = OrthancApiClient('http://localhost:10042', user='test', pwd='test')
        builder = ReportSeriesBuilder(orthanc_client, "Protocole")

        oru_handler = Hl7OruReportMsgHandler(parser=parser, builder=builder)

        mllp_server = MLLPServer(
            host='localhost',
            port=port_number,
            handlers={
                'ORU^R01^ORU_R01': (oru_handler.handle_oru_message,)
            }
        )

        with mllp_server as server:
            # validate that ORU messages do create new series with embedded pdf
            with MLLPClient('localhost', port_number) as client:
                hl7_request = hl7.parse(
                    "\x0bMSH|^~\&|CHLC_CR|CHLC_CR|HM_2792|HM_2792|20210412151547||ORU^R01^ORU_R01|1932e882-d525-4735-98a7-3882daed5866|P|2.5|||||FRA|8859/1\r"
                    "PID|1||00007130^^^GAP&^PI~P379.241588^^^ECSIMAGING^PI||LEnnn^Lpppp^^^^^D~LEnnn^Lpppp^^^^^L||19710101010000|F||||||||M|||||||||||||N\r"
                    "PV1||E||R||||||||||1|||||001191473|||||||||||||||||||||||||20210412162300|\r"
                    "OBR|||1.3.6.1.4.1.5962.1.2.1.20040119072730.12322^ECSIMAGING|TX^THORAX^ECS|||20210412171505|||||||||579^URGENCES^Ch Le Cateau^^^^^^CHLC_CR^L^^^EI||A312.114589725||1041314||||||||||||10002226354^DESMETTRE ^Claude^^^^^^ASIP-SANTE-PS&1.2.250.1.71.4.2.1&ISO^L^^^RPPS|||||||||||||||1^Cabinet le Cateau-Cambresis^ECSIMAGING|\r"
                    "OBX|1|ED|18748-4^THORAX^ECSIMAGING||^Application^PDF^Base64^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Mi0xMWU2LTAwMDAtMzBmMjU5OTRlZGRmJyB4bWxuczp4bXA9J2h0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8nPjx4bXA6TW9kaWZ5RGF0ZT4yMDE3LTAxLTE5VDEzOjU4OjIwKzAxOjAwPC94bXA6TW9kaWZ5RGF0ZT4KPHhtcDpDcmVhdGVEYXRlPjIwMTctMDEtMTlUMTM6NTg6MjArMDE6MDA8L3htcDpDcmVhdGVEYXRlPgo8eG1wOkNyZWF0b3JUb29sPlBTY3JpcHQ1LmRsbCBWZXJzaW9uIDUuMi4yPC94bXA6Q3JlYXRvclRvb2w+PC9yZGY6RGVzY3JpcHRpb24+CjxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSd1dWlkOjczYjEyOWIzLWUwYTItMTFlNi0wMDAwLTMwZjI1OTk0ZWRkZicgeG1sbnM6eGFwTU09J2h0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8nIHhhcE1NOkRvY3VtZW50SUQ9J3V1aWQ6NzNiMTI5YjMtZTBhMi0xMWU2LTAwMDAtMzBmMjU5OTRlZGRmJy8+CjxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSd1dWlkOjczYjEyOWIzLWUwYTItMTFlNi0wMDAwLTMwZjI1OTk0ZWRkZicgeG1sbnM6ZGM9J2h0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvJyBkYzpmb3JtYXQ9J2FwcGxpY2F0aW9uL3BkZic+PGRjOnRpdGxlPjxyZGY6QWx0PjxyZGY6bGkgeG1sOmxhbmc9J3gtZGVmYXVsdCc+TWljcm9zb2Z0IFdvcmQgLSBEb2N1bWVudDE8L3JkZjpsaT48L3JkZjpBbHQ+PC9kYzp0aXRsZT48ZGM6Y3JlYXRvcj48cmRmOlNlcT48cmRmOmxpPmFsYWluPC9yZGY6bGk+PC9yZGY6U2VxPjwvZGM6Y3JlYXRvcj48L3JkZjpEZXNjcmlwdGlvbj4KPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAo8P3hwYWNrZXQgZW5kPSd3Jz8+CmVuZHN0cmVhbQplbmRvYmoKMiAwIG9iago8PC9Qcm9kdWNlcihHUEwgR2hvc3RzY3JpcHQgOS4wNikKL0NyZWF0aW9uRGF0ZShEOjIwMTcwMTE5MTM1ODIwKzAxJzAwJykKL01vZERhdGUoRDoyMDE3MDExOTEzNTgyMCswMScwMCcpCi9UaXRsZShNaWNyb3NvZnQgV29yZCAtIERvY3VtZW50MSkKL0NyZWF0b3IoUFNjcmlwdDUuZGxsIFZlcnNpb24gNS4yLjIpCi9BdXRob3IoYWxhaW4pPj5lbmRvYmoKeHJlZgowIDE1CjAwMDAwMDAwMDAgNjU1MzUgZiAKMDAwMDAwMDUzNyAwMDAwMCBuIAowMDAwMDA3Mjg0IDAwMDAwIG4gCjAwMDAwMDA0NjkgMDAwMDAgbiAKMDAwMDAwMDMwOSAwMDAwMCBuIAowMDAwMDAwMDE1IDAwMDAwIG4gCjAwMDAwMDAyOTAgMDAwMDAgbiAKMDAwMDAwMDYwMiAwMDAwMCBuIAowMDAwMDAwOTg5IDAwMDAwIG4gCjAwMDAwMDExODIgMDAwMDAgbiAKMDAwMDAwMDY0MyAwMDAwMCBuIAowMDAwMDAwNjczIDAwMDAwIG4gCjAwMDAwMDE0MjkgMDAwMDAgbiAKMDAwMDAwMDcwMyAwMDAwMCBuIAowMDAwMDA1NzcxIDAwMDAwIG4gCnRyYWlsZXIKPDwgL1NpemUgMTUgL1Jvb3QgMSAwIFIgL0luZm8gMiAwIFIKL0lEIFs8MDhCRTlERkY1QjkyRUE3NDdCRUM1MEI5MUY0MEU5RUM+PDA4QkU5REZGNUI5MkVBNzQ3QkVDNTBCOTFGNDBFOUVDPl0KPj4Kc3RhcnR4cmVmCjc0OTQKJSVFT0YK||||||F|||20210412171505\r"
                    "ZDS|1.3.6.1.4.1.5962.1.2.1.20040119072730.12322^ECSIMAGING^Application^DICOM\r"
                    "\x1c\x0d"
                )
                response = client.send(hl7_request)
                hl7_response = hl7.parse(response)

            # make sure the created pdf is the same as the original
            pdf_instance_id = self.oa.studies.get_pdf_instances(original_study_id)[0]
            with tempfile.NamedTemporaryFile() as f:
                self.oa.instances.download_pdf(pdf_instance_id, f.name)
                new_pdf_file_content = f.read()
            with open(here / "tests/stimuli/sample.pdf", 'rb') as f1:
                original_pdf_file_content = f1.read()
            self.assertEqual(new_pdf_file_content, original_pdf_file_content)

            # make sure the hl7 response contains the "AA" (meaning "message well processed")
            self.assertEqual(hl7_response['MSA.F1.R1'],"AA")

    def test_ried_invalid_reports(self):
        """
        This is almost the same tests as the previous one, but the string containing base64 encoded pdf
        has been modified to be invalid, so the server should return an error
        """

        # upload the study we will attach the pdf to
        original_instance_id = self.oa.upload_file(here / "tests/stimuli/CT_small.dcm")[0]
        original_study_id = self.oa.instances.get_parent_study_id(original_instance_id)

        port_number = 2001  # there are currently some issues when trying to reuse the same port in 2 tests (it's probably not freed soon enough -> let's use another port for each test)

        parser = Hl7ReportParser()
        orthanc_client = OrthancApiClient('http://localhost:10042', user='test', pwd='test')
        builder = ReportSeriesBuilder(orthanc_client, "Protocole")

        oru_handler = Hl7OruReportMsgHandler(parser=parser, builder=builder)

        mllp_server = MLLPServer(
            host='localhost',
            port=port_number,
            handlers={
                'ORU^R01^ORU_R01': (oru_handler.handle_oru_message,)
            }
        )

        with mllp_server as server:
            # validate that ORU messages do create new series with embedded pdf
            with MLLPClient('localhost', port_number) as client:
                hl7_request = hl7.parse(
                    "\x0bMSH|^~\&|CHLC_CR|CHLC_CR|HM_2792|HM_2792|20210412151547||ORU^R01^ORU_R01|1932e882-d525-4735-98a7-3882daed5866|P|2.5|||||FRA|8859/1\r"
                    "PID|1||00007130^^^GAP&^PI~P379.241588^^^ECSIMAGING^PI||LEnnn^Lpppp^^^^^D~LEnnn^Lpppp^^^^^L||19710101010000|F||||||||M|||||||||||||N\r"
                    "PV1||E||R||||||||||1|||||001191473|||||||||||||||||||||||||20210412162300|\r"
                    "OBR|||1.3.6.1.4.1.5962.1.2.1.20040119072730.12322^ECSIMAGING|TX^THORAX^ECS|||20210412171505|||||||||579^URGENCES^Ch Le Cateau^^^^^^CHLC_CR^L^^^EI||A312.114589725||1041314||||||||||||10002226354^DESMETTRE ^Claude^^^^^^ASIP-SANTE-PS&1.2.250.1.71.4.2.1&ISO^L^^^RPPS|||||||||||||||1^Cabinet le Cateau-Cambresis^ECSIMAGING|\r"
                    "OBX|1|ED|18748-4^THORAX^ECSIMAGING||^Application^PDF^Base64^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wMDAtMzBmMjU5OTRlZGRmJyB4bWxuczp4bXA9J2h0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8nPjx4bXA6TW9kaWZ5RGF0ZT4yMDE3LTAxLTE5VDEzOjU4OjIwKzAxOjAwPC94bXA6TW9kaWZ5RGF0ZT4KPHhtcDpDcmVhdGVEYXRlPjIwMTctMDEtMTlUMTM6NTg6MjArMDE6MDA8L3htcDpDcmVhdGVEYXRlPgo8eG1wOkNyZWF0b3JUb29sPlBTY3JpcHQ1LmRsbCBWZXJzaW9uIDUuMi4yPC94bXA6Q3JlYXRvclRvb2w+PC9yZGY6RGVzY3JpcHRpb24+CjxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSd1dWlkOjczYjEyOWIzLWUwYTItMTFlNi0wMDAwLTMwZjI1OTk0ZWRkZicgeG1sbnM6eGFwTU09J2h0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8nIHhhcE1NOkRvY3VtZW50SUQ9J3V1aWQ6NzNiMTI5YjMtZTBhMi0xMWU2LTAwMDAtMzBmMjU5OTRlZGRmJy8+CjxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSd1dWlkOjczYjEyOWIzLWUwYTItMTFlNi0wMDAwLTMwZjI1OTk0ZWRkZicgeG1sbnM6ZGM9J2h0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvJyBkYzpmb3JtYXQ9J2FwcGxpY2F0aW9uL3BkZic+PGRjOnRpdGxlPjxyZGY6QWx0PjxyZGY6bGkgeG1sOmxhbmc9J3gtZGVmYXVsdCc+TWljcm9zb2Z0IFdvcmQgLSBEb2N1bWVudDE8L3JkZjpsaT48L3JkZjpBbHQ+PC9kYzp0aXRsZT48ZGM6Y3JlYXRvcj48cmRmOlNlcT48cmRmOmxpPmFsYWluPC9yZGY6bGk+PC9yZGY6U2VxPjwvZGM6Y3JlYXRvcj48L3JkZjpEZXNjcmlwdGlvbj4KPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAo8P3hwYWNrZXQgZW5kPSd3Jz8+CmVuZHN0cmVhbQplbmRvYmoKMiAwIG9iago8PC9Qcm9kdWNlcihHUEwgR2hvc3RzY3JpcHQgOS4wNikKL0NyZWF0aW9uRGF0ZShEOjIwMTcwMTE5MTM1ODIwKzAxJzAwJykKL01vZERhdGUoRDoyMDE3MDExOTEzNTgyMCswMScwMCcpCi9UaXRsZShNaWNyb3NvZnQgV29yZCAtIERvY3VtZW50MSkKL0NyZWF0b3IoUFNjcmlwdDUuZGxsIFZlcnNpb24gNS4yLjIpCi9BdXRob3IoYWxhaW4pPj5lbmRvYmoKeHJlZgowIDE1CjAwMDAwMDAwMDAgNjU1MzUgZiAKMDAwMDAwMDUzNyAwMDAwMCBuIAowMDAwMDA3Mjg0IDAwMDAwIG4gCjAwMDAwMDA0NjkgMDAwMDAgbiAKMDAwMDAwMDMwOSAwMDAwMCBuIAowMDAwMDAwMDE1IDAwMDAwIG4gCjAwMDAwMDAyOTAgMDAwMDAgbiAKMDAwMDAwMDYwMiAwMDAwMCBuIAowMDAwMDAwOTg5IDAwMDAwIG4gCjAwMDAwMDExODIgMDAwMDAgbiAKMDAwMDAwMDY0MyAwMDAwMCBuIAowMDAwMDAwNjczIDAwMDAwIG4gCjAwMDAwMDE0MjkgMDAwMDAgbiAKMDAwMDAwMDcwMyAwMDAwMCBuIAowMDAwMDA1NzcxIDAwMDAwIG4gCnRyYWlsZXIKPDwgL1NpemUgMTUgL1Jvb3QgMSAwIFIgL0luZm8gMiAwIFIKL0lEIFs8MDhCRTlERkY1QjkyRUE3NDdCRUM1MEI5MUY0MEU5RUM+PDA4QkU5REZGNUI5MkVBNzQ3QkVDNTBCOTFGNDBFOUVDPl0KPj4Kc3RhcnR4cmVmCjc0OTQKJSVFT0YK||||||F|||20210412171505\r"
                    "ZDS|1.3.6.1.4.1.5962.1.2.1.20040119072730.12322^ECSIMAGING^Application^DICOM\r"
                    "\x1c\x0d"
                )
                response = client.send(hl7_request)
                hl7_response = hl7.parse(response)

            # make sure the hl7 response contains the "AA" (meaning "message well processed")
            self.assertEqual(hl7_response['MSA.F1.R1'],"AE")